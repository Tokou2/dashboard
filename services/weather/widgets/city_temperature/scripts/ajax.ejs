<script type="text/javascript">
	<% if (locals.options) { %>
		let options = <%- locals.options %>;
		console.log(options);
		if (!options.location_key || options.location_key === '') {
			console.log("location undefined");
			if (!options.city || options.city === '') {
				console.log("city undefined");
				getLocationKey('Lyon');
			}
			else {
				getLocationKey(options.city);
			}
		}

		function getLocationKey(city) {
			let url = `${options.base_url}/locations/v1/cities/search?apikey=${options.api_key}&q=${city}`;
			return $.ajax({
				url: url,
				type: "GET",
				dataType: 'jsonp'
			}).done((data) => {
				if (data && data[0]) {
					console.log('locationKey', data[0]);
					update({
						location_key: data[0].Key
					}).catch((err) => {console.log(err);});
				}
				else {
					console.log('city not found');
				}
			});
		}

		function update(data) {
			return $.ajax({
				url: '/',
				type: 'POST',
				data: data
			});
		}
	<% } %>
</script>
